<!DOCTYPE html>
<html>
<head>
    <title>WebRTC Data Channel Example</title>
</head>
<body>
    <h1>WebRTC Data Channel Example</h1>
    <pre id="output"></pre>

    <script>
        const outputElement = document.getElementById('output');
        let ws, pc, dataChannel, iceCandidates = [], state = 'new';

        function log(...args) {
            outputElement.textContent += args.join(' ') + '\n';
        }

        function setupWebSocket() {
            let proto = location.protocol === 'https:' ? 'wss' : 'ws';
            ws = new WebSocket(proto + '://' + location.host + '/ws');
            
            ws.onopen = () => {
                log('WebSocket connection opened');
                createConnection();
            };

            ws.onmessage = async event => {
                const message = JSON.parse(event.data);

                if (message.sdp) {
                    await handleSDPMessage(message.sdp);
                } else if (message.candidate) {
                    await handleICECandidate(message.candidate);
                } else {
                    log('Received unknown message type:', message);
                }
            };

            ws.onclose = () => {
                log('WebSocket connection closed, retrying in 5 seconds...');
                setTimeout(setupWebSocket, 5000);
            };

            ws.onerror = error => {
                log('WebSocket error: ' + error.message);
                ws.close();
            };
        }

        async function createConnection() {
            pc = new RTCPeerConnection({
                iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
            });

            pc.onicecandidate = event => {
                if (event.candidate) {
                    ws.send(JSON.stringify({ 'candidate': event.candidate }));
                }
            };

            pc.ondatachannel = event => {
                dataChannel = event.channel;
                setupDataChannel();
            };

            pc.oniceconnectionstatechange = () => {
                if (pc.iceConnectionState === 'disconnected') {
                    log('ICE connection state is disconnected, closing peer connection');
                    pc.close();
                    state = 'new';
                }
            };

            if (state === 'new') {
                dataChannel = pc.createDataChannel('chat');
                setupDataChannel();
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                state = 'offer-sent';
                ws.send(JSON.stringify({ 'sdp': pc.localDescription }));
            }
        }

        async function handleSDPMessage(sdp) {
            try {
                if (sdp.type === 'offer' && (state === 'new' || state === 'offer-sent')) {
                    await createConnection();
                    await pc.setRemoteDescription(new RTCSessionDescription(sdp));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    state = 'answer-sent';
                    ws.send(JSON.stringify({ 'sdp': pc.localDescription }));
                } else if (sdp.type === 'answer' && state === 'offer-sent') {
                    await pc.setRemoteDescription(new RTCSessionDescription(sdp));
                    state = 'connected';
                }
            } catch (e) {
                log('Error handling SDP message:', e);
            }
        }

        async function handleICECandidate(candidate) {
            try {
                if (pc.remoteDescription) {
                    await pc.addIceCandidate(new RTCIceCandidate(candidate));
                } else {
                    iceCandidates.push(candidate);
                }
            } catch (e) {
                log('Error adding received ICE candidate:', e);
            }
        }

        function setupDataChannel() {
            dataChannel.onopen = () => {
                log('Data Channel Opened');
                setInterval(() => {
                    const message = JSON.stringify({ 
                        'userAgent': navigator.userAgent, 
                        'timestamp': new Date().toISOString() 
                    });
                    if (dataChannel.readyState === 'open') {
                        dataChannel.send(message);
                    }
                }, 5000);
            };

            dataChannel.onmessage = event => {
                const message = JSON.parse(event.data);
                log(`Received: UserAgent: ${message.userAgent}, Timestamp: ${message.timestamp}`);
            };

            dataChannel.onclose = () => {
                log('Data Channel Closed');
            };

            dataChannel.onerror = error => {
                log('Data Channel Error: ' + error.message);
            };
        }

        setupWebSocket();
    </script>
</body>
</html>
