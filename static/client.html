<!DOCTYPE html>
<html>
<head>
    <title>WebRTC Data Channel Example</title>
</head>
<body>
    <h1>WebRTC Data Channel Example</h1>
    <pre id="output"></pre>

    <script>
        const outputElement = document.getElementById('output');
        let ws, pc, dataChannel;

        function log(message) {
            outputElement.textContent += message + '\n';
        }

        function setupWebSocket() {
            ws = new WebSocket('ws://' + location.host + '/ws');
            
            ws.onopen = () => {
                log('WebSocket connection opened');
                createConnection();
            };

            ws.onmessage = async event => {
                const message = JSON.parse(event.data);

                if (message.sdp) {
                    await pc.setRemoteDescription(new RTCSessionDescription(message.sdp));
                    if (message.sdp.type === 'offer') {
                        const answer = await pc.createAnswer();
                        await pc.setLocalDescription(answer);
                        ws.send(JSON.stringify({ 'sdp': pc.localDescription }));
                    }
                } else if (message.candidate) {
                    try {
                        await pc.addIceCandidate(new RTCIceCandidate(message.candidate));
                    } catch (e) {
                        console.error('Error adding received ice candidate', e);
                    }
                }
            };

            ws.onclose = () => {
                log('WebSocket connection closed, retrying in 5 seconds...');
                setTimeout(setupWebSocket, 5000);
            };

            ws.onerror = error => {
                log('WebSocket error: ' + error.message);
                ws.close();
            };
        }

        async function createConnection() {
            pc = new RTCPeerConnection({
                iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
            });

            pc.onicecandidate = event => {
                if (event.candidate) {
                    ws.send(JSON.stringify({ 'candidate': event.candidate }));
                }
            };

            pc.ondatachannel = event => {
                dataChannel = event.channel;
                setupDataChannel();
            };

            try {
                dataChannel = pc.createDataChannel('chat');
                setupDataChannel();

                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                ws.send(JSON.stringify({ 'sdp': pc.localDescription }));
            } catch (e) {
                console.error('Failed to create offer:', e);
            }
        }

        function setupDataChannel() {
            dataChannel.onopen = () => {
                log('Data Channel Opened');
                setInterval(() => {
                    const message = JSON.stringify({ 'content': 'Hello, world' });
                    if (dataChannel.readyState === 'open') {
                        dataChannel.send(message);
                    }
                }, 5000);
            };

            dataChannel.onmessage = (event) => {
                const message = JSON.parse(event.data);
                log(`Received: ${message.content}`);
            };

            dataChannel.onclose = () => {
                log('Data Channel Closed');
            };

            dataChannel.onerror = (error) => {
                log('Data Channel Error: ' + error.message);
            };
        }

        setupWebSocket();
    </script>
</body>
</html>
